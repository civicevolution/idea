(function(a){"use strict";if(typeof define==="function"&&define.amd){define(["jquery","jquery.ui.widget"],a)}else{a(window.jQuery)}})(function(a){"use strict";a.support.xhrFileUpload=!!(window.XMLHttpRequestUpload&&window.FileReader);a.support.xhrFormDataFileUpload=!!window.FormData;a.widget("blueimp.fileupload",{options:{dropZone:a(document),pasteZone:a(document),fileInput:undefined,replaceFileInput:true,paramName:undefined,singleFileUploads:true,limitMultiFileUploads:undefined,sequentialUploads:false,limitConcurrentUploads:undefined,forceIframeTransport:false,redirect:undefined,redirectParamName:undefined,postMessage:undefined,multipart:true,maxChunkSize:undefined,uploadedBytes:undefined,recalculateProgress:true,progressInterval:100,bitrateInterval:500,formData:function(a){return a.serializeArray()},add:function(a,b){b.submit()},processData:false,contentType:false,cache:false},_refreshOptionsList:["fileInput","dropZone","pasteZone","multipart","forceIframeTransport"],_BitrateTimer:function(){this.timestamp=+(new Date);this.loaded=0;this.bitrate=0;this.getBitrate=function(a,b,c){var d=a-this.timestamp;if(!this.bitrate||!c||d>c){this.bitrate=(b-this.loaded)*(1e3/d)*8;this.loaded=b;this.timestamp=a}return this.bitrate}},_isXHRUpload:function(b){return!b.forceIframeTransport&&(!b.multipart&&a.support.xhrFileUpload||a.support.xhrFormDataFileUpload)},_getFormData:function(b){var c;if(typeof b.formData==="function"){return b.formData(b.form)}if(a.isArray(b.formData)){return b.formData}if(b.formData){c=[];a.each(b.formData,function(a,b){c.push({name:a,value:b})});return c}return[]},_getTotal:function(b){var c=0;a.each(b,function(a,b){c+=b.size||1});return c},_onProgress:function(a,b){if(a.lengthComputable){var c=+(new Date),d,e;if(b._time&&b.progressInterval&&c-b._time<b.progressInterval&&a.loaded!==a.total){return}b._time=c;d=b.total||this._getTotal(b.files);e=parseInt(a.loaded/a.total*(b.chunkSize||d),10)+(b.uploadedBytes||0);this._loaded+=e-(b.loaded||b.uploadedBytes||0);b.lengthComputable=true;b.loaded=e;b.total=d;b.bitrate=b._bitrateTimer.getBitrate(c,e,b.bitrateInterval);this._trigger("progress",a,b);this._trigger("progressall",a,{lengthComputable:true,loaded:this._loaded,total:this._total,bitrate:this._bitrateTimer.getBitrate(c,this._loaded,b.bitrateInterval)})}},_initProgressListener:function(b){var c=this,d=b.xhr?b.xhr():a.ajaxSettings.xhr();if(d.upload){a(d.upload).bind("progress",function(a){var d=a.originalEvent;a.lengthComputable=d.lengthComputable;a.loaded=d.loaded;a.total=d.total;c._onProgress(a,b)});b.xhr=function(){return d}}},_initXHRData:function(b){var c,d=b.files[0],e=b.multipart||!a.support.xhrFileUpload,f=b.paramName[0];b.headers=b.headers||{};if(b.contentRange){b.headers["Content-Range"]=b.contentRange}if(!e){b.headers["Content-Disposition"]='attachment; filename="'+encodeURI(d.name)+'"';b.contentType=d.type;b.data=b.blob||d}else if(a.support.xhrFormDataFileUpload){if(b.postMessage){c=this._getFormData(b);if(b.blob){c.push({name:f,value:b.blob})}else{a.each(b.files,function(a,d){c.push({name:b.paramName[a]||f,value:d})})}}else{if(b.formData instanceof FormData){c=b.formData}else{c=new FormData;a.each(this._getFormData(b),function(a,b){c.append(b.name,b.value)})}if(b.blob){b.headers["Content-Disposition"]='attachment; filename="'+encodeURI(d.name)+'"';b.headers["Content-Description"]=encodeURI(d.type);c.append(f,b.blob,d.name)}else{a.each(b.files,function(a,d){if(d instanceof Blob){c.append(b.paramName[a]||f,d,d.name)}})}}b.data=c}b.blob=null},_initIframeSettings:function(b){b.dataType="iframe "+(b.dataType||"");b.formData=this._getFormData(b);if(b.redirect&&a("<a></a>").prop("href",b.url).prop("host")!==location.host){b.formData.push({name:b.redirectParamName||"redirect",value:b.redirect})}},_initDataSettings:function(a){if(this._isXHRUpload(a)){if(!this._chunkedUpload(a,true)){if(!a.data){this._initXHRData(a)}this._initProgressListener(a)}if(a.postMessage){a.dataType="postmessage "+(a.dataType||"")}}else{this._initIframeSettings(a,"iframe")}},_getParamName:function(b){var c=a(b.fileInput),d=b.paramName;if(!d){d=[];c.each(function(){var b=a(this),c=b.prop("name")||"files[]",e=(b.prop("files")||[1]).length;while(e){d.push(c);e-=1}});if(!d.length){d=[c.prop("name")||"files[]"]}}else if(!a.isArray(d)){d=[d]}return d},_initFormSettings:function(b){if(!b.form||!b.form.length){b.form=a(b.fileInput.prop("form"));if(!b.form.length){b.form=a(this.options.fileInput.prop("form"))}}b.paramName=this._getParamName(b);if(!b.url){b.url=b.form.prop("action")||location.href}b.type=(b.type||b.form.prop("method")||"").toUpperCase();if(b.type!=="POST"&&b.type!=="PUT"){b.type="POST"}if(!b.formAcceptCharset){b.formAcceptCharset=b.form.attr("accept-charset")}},_getAJAXSettings:function(b){var c=a.extend({},this.options,b);this._initFormSettings(c);this._initDataSettings(c);return c},_enhancePromise:function(a){a.success=a.done;a.error=a.fail;a.complete=a.always;return a},_getXHRPromise:function(b,c,d){var e=a.Deferred(),f=e.promise();c=c||this.options.context||f;if(b===true){e.resolveWith(c,d)}else if(b===false){e.rejectWith(c,d)}f.abort=e.promise;return this._enhancePromise(f)},_getUploadedBytes:function(a){var b=a.getResponseHeader("Range"),c=b&&b.split("-"),d=c&&c.length>1&&parseInt(c[1],10);return d&&d+1},_chunkedUpload:function(b,c){var d=this,e=b.files[0],f=e.size,g=b.uploadedBytes=b.uploadedBytes||0,h=b.maxChunkSize||f,i=e.slice||e.webkitSlice||e.mozSlice,j=a.Deferred(),k=j.promise(),l,m;if(!(this._isXHRUpload(b)&&i&&(g||h<f))||b.data){return false}if(c){return true}if(g>=f){e.error="Uploaded bytes exceed file size";return this._getXHRPromise(false,b.context,[null,"error",e.error])}m=function(c){var k=a.extend({},b);k.blob=i.call(e,g,g+h);k.chunkSize=k.blob.size;k.contentRange="bytes "+g+"-"+(g+k.chunkSize-1)+"/"+f;d._initXHRData(k);d._initProgressListener(k);l=(a.ajax(k)||d._getXHRPromise(false,k.context)).done(function(c,e,h){g=d._getUploadedBytes(h)||g+k.chunkSize;if(!k.loaded){d._onProgress(a.Event("progress",{lengthComputable:true,loaded:g-k.uploadedBytes,total:g-k.uploadedBytes}),k)}b.uploadedBytes=k.uploadedBytes=g;if(g<f){m()}else{j.resolveWith(k.context,[c,e,h])}}).fail(function(a,b,c){j.rejectWith(k.context,[a,b,c])})};this._enhancePromise(k);k.abort=function(){return l.abort()};m();return k},_beforeSend:function(a,b){if(this._active===0){this._trigger("start");this._bitrateTimer=new this._BitrateTimer}this._active+=1;this._loaded+=b.uploadedBytes||0;this._total+=this._getTotal(b.files)},_onDone:function(b,c,d,e){if(!this._isXHRUpload(e)){this._onProgress(a.Event("progress",{lengthComputable:true,loaded:1,total:1}),e)}e.result=b;e.textStatus=c;e.jqXHR=d;this._trigger("done",null,e)},_onFail:function(a,b,c,d){d.jqXHR=a;d.textStatus=b;d.errorThrown=c;this._trigger("fail",null,d);if(d.recalculateProgress){this._loaded-=d.loaded||d.uploadedBytes||0;this._total-=d.total||this._getTotal(d.files)}},_onAlways:function(a,b,c,d){this._active-=1;d.textStatus=b;if(c&&c.always){d.jqXHR=c;d.result=a}else{d.jqXHR=a;d.errorThrown=c}this._trigger("always",null,d);if(this._active===0){this._trigger("stop");this._loaded=this._total=0;this._bitrateTimer=null}},_onSend:function(b,c){var d=this,e,f,g,h=d._getAJAXSettings(c),i=function(c,f){d._sending+=1;h._bitrateTimer=new d._BitrateTimer;e=e||(c!==false&&d._trigger("send",b,h)!==false&&(d._chunkedUpload(h)||a.ajax(h))||d._getXHRPromise(false,h.context,f)).done(function(a,b,c){d._onDone(a,b,c,h)}).fail(function(a,b,c){d._onFail(a,b,c,h)}).always(function(a,b,c){d._sending-=1;d._onAlways(a,b,c,h);if(h.limitConcurrentUploads&&h.limitConcurrentUploads>d._sending){var e=d._slots.shift(),f;while(e){f=e.state?e.state()==="pending":!e.isRejected();if(f){e.resolve();break}e=d._slots.shift()}}});return e};this._beforeSend(b,h);if(this.options.sequentialUploads||this.options.limitConcurrentUploads&&this.options.limitConcurrentUploads<=this._sending){if(this.options.limitConcurrentUploads>1){f=a.Deferred();this._slots.push(f);g=f.pipe(i)}else{g=this._sequence=this._sequence.pipe(i,i)}g.abort=function(){var a=[undefined,"abort","abort"];if(!e){if(f){f.rejectWith(g,a)}return i(false,a)}return e.abort()};return this._enhancePromise(g)}return i()},_onAdd:function(b,c){var d=this,e=true,f=a.extend({},this.options,c),g=f.limitMultiFileUploads,h=this._getParamName(f),i,j,k,l;if(!(f.singleFileUploads||g)||!this._isXHRUpload(f)){k=[c.files];i=[h]}else if(!f.singleFileUploads&&g){k=[];i=[];for(l=0;l<c.files.length;l+=g){k.push(c.files.slice(l,l+g));j=h.slice(l,l+g);if(!j.length){j=h}i.push(j)}}else{i=h}c.originalFiles=c.files;a.each(k||c.files,function(f,g){var h=a.extend({},c);h.files=k?g:[g];h.paramName=i[f];h.submit=function(){h.jqXHR=this.jqXHR=d._trigger("submit",b,this)!==false&&d._onSend(b,this);return this.jqXHR};return e=d._trigger("add",b,h)});return e},_replaceFileInput:function(b){var c=b.clone(true);a("<form></form>").append(c)[0].reset();b.after(c).detach();a.cleanData(b.unbind("remove"));this.options.fileInput=this.options.fileInput.map(function(a,d){if(d===b[0]){return c[0]}return d});if(b[0]===this.element[0]){this.element=c}},_handleFileTreeEntry:function(b,c){var d=this,e=a.Deferred(),f=function(a){if(a&&!a.entry){a.entry=b}e.resolve([a])},g;c=c||"";if(b.isFile){if(b._file){b._file.relativePath=c;e.resolve(b._file)}else{b.file(function(a){a.relativePath=c;e.resolve(a)},f)}}else if(b.isDirectory){g=b.createReader();g.readEntries(function(a){d._handleFileTreeEntries(a,c+b.name+"/").done(function(a){e.resolve(a)}).fail(f)},f)}else{e.resolve([])}return e.promise()},_handleFileTreeEntries:function(b,c){var d=this;return a.when.apply(a,a.map(b,function(a){return d._handleFileTreeEntry(a,c)})).pipe(function(){return Array.prototype.concat.apply([],arguments)})},_getDroppedFiles:function(b){b=b||{};var c=b.items;if(c&&c.length&&(c[0].webkitGetAsEntry||c[0].getAsEntry)){return this._handleFileTreeEntries(a.map(c,function(a){var b;if(a.webkitGetAsEntry){b=a.webkitGetAsEntry();if(b){b._file=a.getAsFile()}return b}return a.getAsEntry()}))}return a.Deferred().resolve(a.makeArray(b.files)).promise()},_getSingleFileInputFiles:function(b){b=a(b);var c=b.prop("webkitEntries")||b.prop("entries"),d,e;if(c&&c.length){return this._handleFileTreeEntries(c)}d=a.makeArray(b.prop("files"));if(!d.length){e=b.prop("value");if(!e){return a.Deferred().resolve([]).promise()}d=[{name:e.replace(/^.*\\/,"")}]}else if(d[0].name===undefined&&d[0].fileName){a.each(d,function(a,b){b.name=b.fileName;b.size=b.fileSize})}return a.Deferred().resolve(d).promise()},_getFileInputFiles:function(b){if(!(b instanceof a)||b.length===1){return this._getSingleFileInputFiles(b)}return a.when.apply(a,a.map(b,this._getSingleFileInputFiles)).pipe(function(){return Array.prototype.concat.apply([],arguments)})},_onChange:function(b){var c=this,d={fileInput:a(b.target),form:a(b.target.form)};this._getFileInputFiles(d.fileInput).always(function(a){d.files=a;if(c.options.replaceFileInput){c._replaceFileInput(d.fileInput)}if(c._trigger("change",b,d)!==false){c._onAdd(b,d)}})},_onPaste:function(b){var c=b.originalEvent.clipboardData,d=c&&c.items||[],e={files:[]};a.each(d,function(a,b){var c=b.getAsFile&&b.getAsFile();if(c){e.files.push(c)}});if(this._trigger("paste",b,e)===false||this._onAdd(b,e)===false){return false}},_onDrop:function(a){a.preventDefault();var b=this,c=a.dataTransfer=a.originalEvent.dataTransfer,d={};this._getDroppedFiles(c).always(function(c){d.files=c;if(b._trigger("drop",a,d)!==false){b._onAdd(a,d)}})},_onDragOver:function(a){var b=a.dataTransfer=a.originalEvent.dataTransfer;if(this._trigger("dragover",a)===false){return false}if(b){b.dropEffect="copy"}a.preventDefault()},_initEventHandlers:function(){if(this._isXHRUpload(this.options)){this._on(this.options.dropZone,{dragover:this._onDragOver,drop:this._onDrop});this._on(this.options.pasteZone,{paste:this._onPaste})}this._on(this.options.fileInput,{change:this._onChange})},_destroyEventHandlers:function(){this._off(this.options.dropZone,"dragover drop");this._off(this.options.pasteZone,"paste");this._off(this.options.fileInput,"change")},_setOption:function(b,c){var d=a.inArray(b,this._refreshOptionsList)!==-1;if(d){this._destroyEventHandlers()}this._super(b,c);if(d){this._initSpecialOptions();this._initEventHandlers()}},_initSpecialOptions:function(){var b=this.options;if(b.fileInput===undefined){b.fileInput=this.element.is('input[type="file"]')?this.element:this.element.find('input[type="file"]')}else if(!(b.fileInput instanceof a)){b.fileInput=a(b.fileInput)}if(!(b.dropZone instanceof a)){b.dropZone=a(b.dropZone)}if(!(b.pasteZone instanceof a)){b.pasteZone=a(b.pasteZone)}},_create:function(){var b=this.options;a.extend(b,a(this.element[0].cloneNode(false)).data());this._initSpecialOptions();this._slots=[];this._sequence=this._getXHRPromise(true);this._sending=this._active=this._loaded=this._total=0;this._initEventHandlers()},_destroy:function(){this._destroyEventHandlers()},add:function(b){var c=this;if(!b||this.options.disabled){return}if(b.fileInput&&!b.files){this._getFileInputFiles(b.fileInput).always(function(a){b.files=a;c._onAdd(null,b)})}else{b.files=a.makeArray(b.files);this._onAdd(null,b)}},send:function(b){if(b&&!this.options.disabled){if(b.fileInput&&!b.files){var c=this,d=a.Deferred(),e=d.promise(),f,g;e.abort=function(){g=true;if(f){return f.abort()}d.reject(null,"abort","abort");return e};this._getFileInputFiles(b.fileInput).always(function(a){if(g){return}b.files=a;f=c._onSend(null,b).then(function(a,b,c){d.resolve(a,b,c)},function(a,b,c){d.reject(a,b,c)})});return this._enhancePromise(e)}b.files=a.makeArray(b.files);if(b.files.length){return this._onSend(null,b)}}return this._getXHRPromise(false,b&&b.context)}})})